name: Ubuntu 24.04 x86-64 - build smoke test

on:
  push:
  workflow_dispatch:
  pull_request:

jobs:
  build:
    runs-on: ubuntu-24.04
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Generate (dummy) demo_config.h
        run: |
             cp examples/master/demo_config_template.h examples/master/demo_config.h

      - name: Cache Podman image
        uses: actions/cache@v4
        with:
          path: |
            ~/podman-x86-64-image.tar
          key:
            ${{ runner.os }}-podman-${{ hashFiles('misc/buildtestcontainer/*')
            }}

      - name: Build and save container for x86-64
        run: |
          if [ ! -f ~/podman-x86-64-image.tar ]; then
            podman build misc/buildtestcontainer -t container
            podman save container:latest > ~/podman-x86-64-image.tar
          else
            podman load < ~/podman-x86-64-image.tar
          fi

      - name: Run build in container
        shell: bash
        run: |
          podman run -v $PWD/.:/FreeRTOS-WebRTC-Application --replace --name ggl container:latest bash -c "\
            cd FreeRTOS-WebRTC-Application && \
            rm -rf build/ && \
            cmake -B build \
            -DLIBRARY_LOG_LEVEL=LOG_VERBOSE && \
            make -C build -j$(nproc) \
            "